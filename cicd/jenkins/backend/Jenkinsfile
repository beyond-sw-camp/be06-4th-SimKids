pipeline {
    agent any

    stages {
        stage('Git clone') {
            steps {
                // git clone
                git branch: 'backend-dev', url: 'https://github.com/beyond-sw-camp/be06-4th-SimKids.git'
            }
        }

        stage('Build') {
            steps {
                // gradlew 권한 부여 및 빌드
                sh '''
                chmod +x backend/gradlew
                cd backend
                ./gradlew bootJar
                '''
            }
        }

        stage('Dockerize') {
            steps {
                script {
                    // DockerFile로 image build
                    sh 'echo build..'
                    sh 'docker build --tag simkids/backend:1.$BUILD_ID ./backend'

                    // Docker Login
                    sh 'echo login..'
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-credential', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                            sh 'docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD'
                    }

                    // Docker Push
                    sh 'echo docker push..'
                    sh 'docker push simkids/backend:1.$BUILD_ID'
                }
            }
        }

        stage('sshPublish'){
            steps {
                // SSH 전송 플러그인 사용
                sshPublisher(
                    // 오류 발생 시 진행을 멈춤
                    continueOnError: false,
                    // 오류 발생 시 파이프라인을 실패시킴
                    failOnError: true,
                    // 전송자 목록
                    publishers: [
                        // SSH 전송 설명
                        sshPublisherDesc(
                            // SSH 서버 설정 이름 지정 ( master 노드 )
                            configName: "k8s-master",
                            // 자세한 출력 모드 활성화
                            verbose: true,
                            transfers: [
                                sshTransfer(
                                    // 전송할 파일을 하나의 문자열로 지정
                                    sourceFiles: '/var/lib/jenkins/workspace/backend-pipeline/cicd/k8s/backend/backend-deployment.yml',
                                    //, ./cicd/k8s/backend/backend-deployment-new.yml, ./cicd/k8s/backend/backend-ingress.yml, ./cicd/k8s/backend/backend-ingress-new.yml, ./cicd/k8s/backend/backend-svc.yml, ./cicd/k8s/backend/backend-svc-new.yml',
                                    // 원격 디렉토리 지정 ( 원격서버로 파일을 전송할 위치 )
                                    remoteDirectory: "/home/master/",
                                    // 전송 후 야멜 파일의 VERSION을 파이프라인 빌드 숫자로 변경
                                    // backend-deployment 야멜 파일 실행
                                    execCommand: '''
                                        kubectl apply -f /home/master/backend-deployment.yml
                                        kubectl apply -f /home/master/backend-deployment-new.yml
                                        kubectl apply -f /home/master/backend-ingress.yml
                                        kubectl apply -f /home/master/backend-ingress-new.yml
                                        kubectl apply -f /home/master/backend-svc.yml
                                        kubectl apply -f /home/master/backend-svc-new.yml
                                    '''
                                )
                            ]
                        )
                    ]
                )
            }
        }
    }
}